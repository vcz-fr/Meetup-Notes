# Cloud Native Computing Foundation Bordeaux #6 - ElasticSearch and Kubernetes
ðŸ•‘ *Estimated reading time:* **?mn**

## Table of Contents

## CNCF time
- The CNCF Technical Oversight Committee will soon change. This committee guarantees the ecosystem consistency;
- The [Certified Kubernetes Application Developer (CKAD)](https://www.cncf.io/certification/ckad/) certification is now
  valid for three years. The other CNCF certification is [Certified Kubernetes Administrator (CKA)](https://www.cncf.io/certification/cka/);
- The next KubeCon + CloudNativeCon will be held soon! From March 30th to April 2nd of 2020 in Amsterdam. [Event site](https://events.linuxfoundation.org/kubecon-cloudnativecon-europe/).

## ElasticSearch, Kibana and APM on Kubernetes
By [Michael Morello](https://twitter.com/barkbay), Principal Software Engineer @ Elastic

### Elastic Cloud on Kubernetes

Elastic has a cloud offering for its services. The promise of this offering is to host ElasticSearch, Kibana and other
Elastic products in environments managed by Kubernetes. This offering is now completed with the capability to deploy
such infrastructures on Kubernetes. This product is called [Elastic Cloud on Kubernetes (ECK)](https://www.elastic.co/elastic-cloud-kubernetes).

The recent evolution of Kubernetes motivated Elastic to release a set of [Operators](https://kubernetes.io/docs/concepts/extend-kubernetes/operator/),
that is extensions to the Kubernetes API adding new features simplifying the deployment and management of more complex
resources.

ECK supports vanilla Kubernetes, [OpenShift](https://www.openshift.com/), [Google Kubernetes Engine (GKE)](https://cloud.google.com/kubernetes-engine/),
[Amazon Elastic Kubernetes Service (Amazon EKS)](https://aws.amazon.com/eks/), [Azure Kubernetes Service (AKS)](https://docs.microsoft.com/en-us/azure/aks/)
and many others. It deploys ElasticSearch, Kibana and APM server and brings integration at the operation level (scale,
upgrade), topology (hot, warm, cold, masters) and tools (kubectl).

The operator supports ElasticSearch versions >= 6.8 and > 7.0. In its Custom Resource Definition, `nodesets.*.config`
maps to the ElasticSearch config, that is `elasticsearch.yaml` ([documentation](https://www.elastic.co/guide/en/cloud-on-k8s/1.0/k8s-node-configuration.html#k8s-node-configuration)).
In Kibana's Custom Resource Definition, it is possible to reference a Kubernetes cluster using `spec.elasticsearchref` ([documentation](https://www.elastic.co/guide/en/cloud-on-k8s/1.0/k8s-kibana.html#k8s-kibana-eck-managed-es)).
This will create the required user and permissions for Kibana to access ElasticSearch and the [Services](https://kubernetes.io/docs/concepts/services-networking/service/)
to ease access to the [Pods](https://kubernetes.io/docs/concepts/workloads/pods/pod/). Kibana also manages the
certificated by default but it is possible to override this behavior and use another certification authority by using [cert-manager](https://cert-manager.io/)
for [Let's Encrypt](https://letsencrypt.org/), for instance.

### Kubernetes Operators

An Operator is like an administrator whose knowledge can be automated and presented as an algorithm. On Kubernetes,
there are native resources such as Pods. Operators are controllers having the necessary knowledge about a resource, tool
or solution and allowing to implement a service using Custom Resources.

When a given Custom Resource gets created, its input is first type checked then sent to its operator which fetches the
current state of the ecosystem and initiates the Reconciliation Loop to reach the requested state.

ECK creates a dedicated [StatefulSet](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/), then
generates certificates for the communication between nodes, which are configurable in the API. The user is then randomly
generated and its secret can be imported from a keystore. Eventually, ECK will create the services.

When scaling down, ECK notifies the Pods that will stop so that they can save their data before gracefully disappearing.
ECK proceeds similarly for rolling upgrades, except it will notify ElasticSearch beforehand to avoid it from spawning
nodes during the upgrade.

### Power users

It is possible to override the default behavior of ECK using _podTemplate_ and _volumeClaimTemplates_. The former sets
the resource required by the components while the latter defines how volumes should be provisioned to fine tune
performance, resilience, availability and capacity settings.

To start with ECK, you can run the following command:
`kubectl apply -f https://download.elastic.co/downloads/eck/1.0.0/all-in-one.yaml`. This Operator also manages
Role-Based Access Control (RBAC) and can be found on GitHub ([source](https://github.com/elastic/cloud-on-k8s)). ECK is
also available on the Kubernetes Operator Hub ([source](https://operatorhub.io/operator/elastic-cloud-eck)).

ECK has been designed and developed by engineers that are experienced with both the Elastic Stack and Kubernetes and
only automates tasks when necessary. To send feedback to the team, go to their [Discuss forum](https://discuss.elastic.co/c/eck/79)
or leave an issue on their [GitHub](https://github.com/elastic/cloud-on-k8s).

### Questions and Answers session

#### Do all issuers work with cert-manager?

All issuers should work with cert-manager.

#### Is it possible to add Kibana dashboards with a CRD?

This is not yet possible but it is a very requested feature.

#### Is ECK production ready?

From version 1.0 onwards and the General Availability announcement, it is safe to state that the solution is production
ready.

#### How many devs are there in the team?

Eight remote software engineers, ten or so people including three French and others coming from Poland, the European Union, the United Kingdom, etc.

#### Is ECK officially under support?

Yes, from version 1.0 onwards.

#### How are scaling rules managed?

Currently unopinionated, they are managed by the users. Self-healing capabilities are planned, though.

#### What was the most difficult part during this project, development-wise?

There were multiple:
- ECK and Kubernetes are both distributed systems so managing a distributed system with another one;
- Operators live in the past in the sense that the state they read and process might be different from the actual
  current state. During an iteration of the reconciliation loop, it is crucial not to apply the same non idempotent
  mutations like Pod creations.